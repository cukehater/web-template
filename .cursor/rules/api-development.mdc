# ğŸ”Œ API ê°œë°œ ê°€ì´ë“œë¼ì¸

## ğŸ“‹ **API ë¼ìš°íŠ¸ êµ¬ì¡°**

### **ê¸°ë³¸ êµ¬ì¡°**

```
src/app/api/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ logout/
â”‚   â”‚   â””â”€â”€ route.ts
â”‚   â””â”€â”€ me/
â”‚       â””â”€â”€ route.ts
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ route.ts          # GET, POST
â”‚   â””â”€â”€ [id]/
â”‚       â””â”€â”€ route.ts      # GET, PUT, DELETE
â””â”€â”€ upload/
    â””â”€â”€ route.ts
```

## ğŸ” **ì¸ì¦ ë° ê¶Œí•œ**

### **JWT í† í° ê²€ì¦**

```typescript
// app/api/protected/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { verifyToken } from '@/app/(cms)/_shared/lib/jwt'

export async function GET(request: NextRequest) {
  try {
    const token = request.headers.get('authorization')?.replace('Bearer ', '')

    if (!token) {
      return NextResponse.json(
        { error: 'ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 401 },
      )
    }

    const payload = await verifyToken(token)

    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
    return NextResponse.json({ data: 'ë³´í˜¸ëœ ë°ì´í„°' })
  } catch (error) {
    return NextResponse.json(
      { error: 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤' },
      { status: 401 },
    )
  }
}
```

### **ê¶Œí•œ ê²€ì¦ ë¯¸ë“¤ì›¨ì–´**

```typescript
// lib/auth-middleware.ts
import { NextRequest, NextResponse } from 'next/server'
import { verifyToken } from './jwt'

export async function withAuth(
  request: NextRequest,
  handler: (request: NextRequest, user: any) => Promise<NextResponse>,
) {
  try {
    const token = request.headers.get('authorization')?.replace('Bearer ', '')

    if (!token) {
      return NextResponse.json({ error: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤' }, { status: 401 })
    }

    const user = await verifyToken(token)
    return await handler(request, user)
  } catch (error) {
    return NextResponse.json({ error: 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤' }, { status: 401 })
  }
}
```

## ğŸ“ **ìš”ì²­/ì‘ë‹µ íŒ¨í„´**

### **í‘œì¤€ ì‘ë‹µ í˜•ì‹**

```typescript
interface ApiResponse<T = any> {
  success: boolean
  data?: T
  message?: string
  error?: string
}

// ì„±ê³µ ì‘ë‹µ
export async function GET() {
  try {
    const data = await fetchData()
    return NextResponse.json({
      success: true,
      data,
      message: 'ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤',
    })
  } catch (error) {
    return NextResponse.json(
      {
        success: false,
        error: 'ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
      },
      { status: 500 },
    )
  }
}
```

### **ì—ëŸ¬ ì²˜ë¦¬**

```typescript
// lib/api-error.ts
export class ApiError extends Error {
  constructor(
    public statusCode: number,
    public message: string,
    public code?: string,
  ) {
    super(message)
    this.name = 'ApiError'
  }
}

// ì‚¬ìš© ì˜ˆì‹œ
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()

    if (!body.email) {
      throw new ApiError(400, 'ì´ë©”ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤', 'EMAIL_REQUIRED')
    }

    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
  } catch (error) {
    if (error instanceof ApiError) {
      return NextResponse.json(
        {
          success: false,
          error: error.message,
          code: error.code,
        },
        { status: error.statusCode },
      )
    }

    return NextResponse.json(
      {
        success: false,
        error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      },
      { status: 500 },
    )
  }
}
```

## ğŸ” **ì…ë ¥ ê²€ì¦**

### **Zod ìŠ¤í‚¤ë§ˆ ê²€ì¦**

```typescript
import { z } from 'zod'

const createUserSchema = z.object({
  email: z.string().email('ìœ íš¨í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”'),
  name: z.string().min(1, 'ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤'),
  password: z.string().min(8, 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤'),
  role: z.enum(['user', 'admin']).default('user'),
})

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const validatedData = createUserSchema.parse(body)

    // ê²€ì¦ëœ ë°ì´í„°ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
    const user = await createUser(validatedData)

    return NextResponse.json({
      success: true,
      data: user,
    })
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        {
          success: false,
          error: 'ì…ë ¥ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤',
          details: error.errors,
        },
        { status: 400 },
      )
    }

    throw error
  }
}
```

## ğŸ“Š **ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…**

### **Prisma íŠ¸ëœì­ì…˜**

```typescript
import { prisma } from '@/app/(cms)/_shared/lib/prisma'

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()

    const result = await prisma.$transaction(async tx => {
      // ì‚¬ìš©ì ìƒì„±
      const user = await tx.user.create({
        data: {
          email: body.email,
          name: body.name,
        },
      })

      // í”„ë¡œí•„ ìƒì„±
      const profile = await tx.profile.create({
        data: {
          userId: user.id,
          bio: body.bio,
        },
      })

      return { user, profile }
    })

    return NextResponse.json({
      success: true,
      data: result,
    })
  } catch (error) {
    return NextResponse.json(
      {
        success: false,
        error: 'ì‚¬ìš©ì ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
      },
      { status: 500 },
    )
  }
}
```

## ğŸ“ **íŒŒì¼ ì—…ë¡œë“œ**

### **íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { writeFile } from 'fs/promises'
import { join } from 'path'

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData()
    const file = formData.get('file') as File

    if (!file) {
      return NextResponse.json(
        {
          success: false,
          error: 'íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤',
        },
        { status: 400 },
      )
    }

    // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp']
    if (!allowedTypes.includes(file.type)) {
      return NextResponse.json(
        {
          success: false,
          error: 'ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤',
        },
        { status: 400 },
      )
    }

    // íŒŒì¼ ì €ì¥
    const bytes = await file.arrayBuffer()
    const buffer = Buffer.from(bytes)

    const fileName = `${Date.now()}-${file.name}`
    const filePath = join(process.cwd(), 'public', 'uploads', fileName)

    await writeFile(filePath, buffer)

    return NextResponse.json({
      success: true,
      data: {
        fileName,
        url: `/uploads/${fileName}`,
      },
    })
  } catch (error) {
    return NextResponse.json(
      {
        success: false,
        error: 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
      },
      { status: 500 },
    )
  }
}
```

## ğŸ”„ **ìºì‹± ë° ì„±ëŠ¥**

### **ì‘ë‹µ ìºì‹±**

```typescript
export async function GET(request: NextRequest) {
  try {
    const data = await fetchData()

    const response = NextResponse.json({
      success: true,
      data,
    })

    // ìºì‹œ í—¤ë” ì„¤ì •
    response.headers.set('Cache-Control', 'public, max-age=300') // 5ë¶„

    return response
  } catch (error) {
    // ì—ëŸ¬ ì‘ë‹µì€ ìºì‹œí•˜ì§€ ì•ŠìŒ
    return NextResponse.json(
      {
        success: false,
        error: 'ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
      },
      { status: 500 },
    )
  }
}
```

## ğŸ§ª **í…ŒìŠ¤íŠ¸ íŒ¨í„´**

### **API í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ**

```typescript
// __tests__/api/users.test.ts
import { describe, it, expect } from 'vitest'
import { POST } from '@/app/api/users/route'

describe('POST /api/users', () => {
  it('should create a new user', async () => {
    const request = new Request('http://localhost:3000/api/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        email: 'test@example.com',
        name: 'Test User',
        password: 'password123',
      }),
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(200)
    expect(data.success).toBe(true)
    expect(data.data.email).toBe('test@example.com')
  })
})
```

## ğŸ“‹ **API ê°œë°œ ì²´í¬ë¦¬ìŠ¤íŠ¸**

### **ê¸°ë³¸ ê²€ì¦**

- [ ] HTTP ë©”ì„œë“œ ì ì ˆíˆ ì‚¬ìš© (GET, POST, PUT, DELETE)
- [ ] ì…ë ¥ ë°ì´í„° Zod ìŠ¤í‚¤ë§ˆë¡œ ê²€ì¦
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë° ì ì ˆí•œ HTTP ìƒíƒœ ì½”ë“œ ë°˜í™˜
- [ ] ì‘ë‹µ í˜•ì‹ ì¼ê´€ì„± ìœ ì§€

### **ë³´ì•ˆ ê²€ì¦**

- [ ] ì¸ì¦ í† í° ê²€ì¦ (í•„ìš”ì‹œ)
- [ ] ê¶Œí•œ ê²€ì¦ (í•„ìš”ì‹œ)
- [ ] ì…ë ¥ ë°ì´í„° sanitization
- [ ] CORS ì„¤ì • (í•„ìš”ì‹œ)

### **ì„±ëŠ¥ ê²€ì¦**

- [ ] ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”
- [ ] ì ì ˆí•œ ìºì‹± ì „ëµ
- [ ] ì‘ë‹µ ì‹œê°„ ìµœì í™”
- [ ] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”

## ğŸš« **ê¸ˆì§€ ì‚¬í•­**

### **ë³´ì•ˆ ê´€ë ¨**

- âŒ ë¯¼ê°í•œ ì •ë³´ë¥¼ ì‘ë‹µì— í¬í•¨
- âŒ SQL ì¸ì ì…˜ ì·¨ì•½ì 
- âŒ ì ì ˆí•œ ê²€ì¦ ì—†ì´ ì‚¬ìš©ì ì…ë ¥ ì‹ ë¢°
- âŒ í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ë‚˜ API í‚¤

### **ì„±ëŠ¥ ê´€ë ¨**

- âŒ N+1 ì¿¼ë¦¬ ë¬¸ì œ
- âŒ ë¶ˆí•„ìš”í•œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
- âŒ ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì²˜ë¦¬
- âŒ ì ì ˆí•œ ì¸ë±ìŠ¤ ì—†ì´ ì¿¼ë¦¬ ì‹¤í–‰
  description:
  globs:
  alwaysApply: false

---
